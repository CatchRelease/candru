var Emitter,noop,slice=[].slice,bind=function(e,t){return function(){return e.apply(t,arguments)}},extend1=function(e,t){function l(){this.constructor=e}for(var a in t)hasProp.call(t,a)&&(e[a]=t[a]);return l.prototype=t.prototype,e.prototype=new l,e.__super__=t.prototype,e},hasProp={}.hasOwnProperty;noop=function(){},Emitter=function(){function e(){}return e.prototype.addEventListener=e.prototype.on,e.prototype.on=function(e,t){return this._callbacks=this._callbacks||{},this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(t),this},e.prototype.emit=function(){var e,t,l,a,n,r;if(a=arguments[0],e=2<=arguments.length?slice.call(arguments,1):[],this._callbacks=this._callbacks||{},l=this._callbacks[a])for(n=0,r=l.length;r>n;n++)t=l[n],t.apply(this,e);return this},e.prototype.removeListener=e.prototype.off,e.prototype.removeAllListeners=e.prototype.off,e.prototype.removeEventListener=e.prototype.off,e.prototype.off=function(e,t){var l,a,n,r,i;if(!this._callbacks||0===arguments.length)return this._callbacks={},this;if(a=this._callbacks[e],!a)return this;if(1===arguments.length)return delete this._callbacks[e],this;for(n=r=0,i=a.length;i>r;n=++r)if(l=a[n],l===t){a.splice(n,1);break}return this},e}(),window.Candru=function(e){function t(e,t){var l;return null==t&&(t={}),this.cancelAll=bind(this.cancelAll,this),this.processQueue=bind(this.processQueue,this),this.uploadError=bind(this.uploadError,this),this.uploadWarn=bind(this.uploadWarn,this),this.uploadInfo=bind(this.uploadInfo,this),this.uploadCancel=bind(this.uploadCancel,this),this.uploadProgress=bind(this.uploadProgress,this),this.uploadComplete=bind(this.uploadComplete,this),this.uploadHandler=bind(this.uploadHandler,this),this.dropHandler=bind(this.dropHandler,this),this.createUploadItem=bind(this.createUploadItem,this),this.getCancelEl=bind(this.getCancelEl,this),this.getMeterEl=bind(this.getMeterEl,this),this.leaveHandler=bind(this.leaveHandler,this),this.overHandler=bind(this.overHandler,this),l={debug:!1,queue:!1,overClass:"candru-over",cancelSelector:".cancel",fileInputSelector:'input[type="file"]',emptyTextSelector:".empty-text",uploadSuccessClass:"done",uploadFailedClass:"failed",uploadCancelledClass:"cancelled",allowedTypes:[/^image\//,/^video\//],maxFileSize:4294967296,evaporate:null,sanitizeFilename:this.sanitizeFilename,renameFile:this.renameFile,overHandler:this.overHandler,leaveHandler:this.leaveHandler,dropHandler:this.dropHandler,getMeterEl:this.getMeterEl,getCancelEl:this.getCancelEl,uploadHandler:this.uploadHandler,uploadComplete:this.uploadComplete,uploadStartCallback:noop,uploadCompleteCallback:noop,uploadProgress:this.uploadProgress,uploadCancel:this.uploadCancel,uploadInfo:this.uploadInfo,uploadWarn:this.uploadWarn,uploadError:this.uploadError,createUploadItem:this.createUploadItem},this._index=0,this._complete=0,this._cancelled=0,this._failed=0,this._fileQueue=[],this.defaults=a(l,t),this.el=window.document.querySelector(e),this.el?void this.init():void console.log("Could not find element for uploader.")}var l,a,n,r,i;return extend1(t,e),a=function(e,t){var l,a;for(l in t)a=t[l],e[l]=a;return e},l=function(e,t){return e.classList?e.classList.add(t):e.className+=" "+t},i=function(e,t){return e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," ")},n=function(e,t){return e.classList?e.classList.contains(t):new RegExp("(^| )"+t+"( |$)","gi").test(e.className)},r=function(e){var t;return 0===e?"0.00 B":(t=Math.floor(Math.log(e)/Math.log(1024)),(e/Math.pow(1024,t)).toFixed(2)+" "+" KMGTP".charAt(t)+"B")},t.prototype.init=function(){var e;return this.el.addEventListener("dragover",this.defaults.overHandler),this.el.addEventListener("dragleave",this.defaults.leaveHandler),this.el.addEventListener("drop",this.defaults.dropHandler),e=this.el.querySelector(this.defaults.fileInputSelector),null!=e?e.addEventListener("change",this.defaults.dropHandler):void 0},t.prototype.overHandler=function(e){return e.preventDefault(),e.stopPropagation(),this.emit("candru-dragover",e),l(this.el,this.defaults.overClass),!1},t.prototype.leaveHandler=function(e){return e.preventDefault(),e.stopPropagation(),this.emit("candru-dragleave",e),i(this.el,this.defaults.overClass),!1},t.prototype.fileTypeCheck=function(e){var t,l,a,n,r;for(t=!1,n=this.defaults.allowedTypes,l=0,a=n.length;a>l;l++)if(r=n[l],r.test(e.type)){t=!0;break}return t},t.prototype.fileSizeCheck=function(e){return e.size>this.defaults.maxFileSize?!1:!0},t.prototype.sanitizeFilename=function(e){var t,l,a,n,r,i;return r=/\ /g,l=/[\/\?<>\\:\*\|":]/g,t=/[\x00-\x1f\x80-\x9f]/g,n=/^\.+$/,i=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,a="",e.name.toLowerCase().replace(r,"_").replace(l,a).replace(t,a).replace(n,a).replace(i,a)},t.prototype.renameFile=function(e){return e.name},t.prototype.getMeterEl=function(e){var t;return t='.candru [data-upload-id="'+e+'"] .meter',this.el.querySelector(t)},t.prototype.getCancelEl=function(e){var t;return t='.candru [data-upload-id="'+e+'"] .cancel',this.el.querySelector(t)},t.prototype.createUploadItem=function(e,t){var l;return l=document.createElement("div"),l.className="candru-upload clearfix",l.dataset.uploadId=t,l.innerHTML="<button class='cancel left tiny'>Cancel</button>\n<span class='filename left'>\n  <label>\n      File:\n  </label>\n  "+e.name+"\n</span>\n<span class='filesize left'>\n  <label>\n      Size:\n  </label>\n  "+r(e.size)+"\n</span>\n<div class='candru-progress right'>\n  <span class='meter'></span>\n</div>",l.querySelector(this.defaults.cancelSelector).addEventListener("click",function(l){return function(a){return function(t){return l.defaults.uploadCancel(e,t)}(t)}}(this)),l},t.prototype.dropHandler=function(e){var t,l,a,n,r,s;for(e.preventDefault(),e.stopPropagation(),this.emit("candru-drop",e),i(this.el,this.defaults.overClass),t=this.el.querySelector(this.defaults.emptyTextSelector),null!=t&&t.parentNode.removeChild(t),a=function(){if(null!=e.dataTransfer)return e.dataTransfer.files;if(e.currentTarget)return e.currentTarget.files;throw new Error("Could not find the files")}(),n=0,r=a.length;r>n;n++)l=a[n],this.fileTypeCheck(l)?this.fileSizeCheck(l)?(s=this.defaults.createUploadItem(l,this._index),this.el.appendChild(s),l.uniqueId=Math.random().toString(36).substr(2,16),l.sanitizedFileName=this.defaults.sanitizeFilename(l),l.uploadName=this.defaults.renameFile(l),this.defaults.queue?(this.emit("candru-queue-add",l,this._index,"unprocessed"),this._fileQueue.push({file:l,index:this._index,state:"unprocessed"})):(this.emit("candru-process",l,this._index),this.defaults.uploadHandler(l,this._index)),this._index++):console.log("Skipping file of size: ",l.size):console.log("Skipping file of type: ",l.type);return!1},t.prototype.uploadHandler=function(e,t){var l;if(!this.defaults.evaporate)throw new Error("Evaporate instance is null.");return l=this.defaults.evaporate,this.defaults.uploadStartCallback(e,t,this.allFilesFinished()),l.add({name:e.uploadName,file:e,complete:function(l){return function(a){var n;return n=a.responseURL,e.awsPath=n.substr(0,n.lastIndexOf("?")).replace(/%2F/g,"/"),l.emit("candru-evaporate-complete",e,t),l.defaults.uploadComplete(e,t)}}(this),progress:function(l){return function(a){return l.emit("candru-evaporate-complete",a,e,t),l.defaults.uploadProgress(a,e,t)}}(this),info:function(l){return function(a){return l.emit("candru-evaporate-info",a,e,t),l.defaults.uploadInfo(a,e,t)}}(this),warn:function(l){return function(a){return l.emit("candru-evaporate-warn",a,e,t),l.defaults.uploadWarn(a,e,t)}}(this),error:function(l){return function(a){return l.emit("candru-evaporate-error",a,e,t),l.defaults.uploadError(a,e,t)}}(this)})},t.prototype.uploadComplete=function(e,t){var a,n;return this._complete++,n=this.defaults.getMeterEl(t),n.style.width="100%",l(n,this.defaults.uploadSuccessClass),a=this.defaults.getCancelEl(t),l(a,"disabled"),this.defaults.uploadCompleteCallback(e,t,this.allFilesFinished())},t.prototype.uploadProgress=function(e,t,l){var a;return a=this.defaults.getMeterEl(l),a.style.width=100*e+"%"},t.prototype.uploadCancel=function(e,t){var a,r,i,s,o,u,d;if(a=this.defaults.getCancelEl(t),!n(a,"disabled")){if(this._cancelled++,!this.defaults.evaporate)throw new Error("Evaporate instance is null.");if(r=this.defaults.evaporate,d=this.defaults.getMeterEl(t),l(d,this.defaults.uploadCancelledClass),d.style.width="100%",a=this.defaults.getCancelEl(t),l(a,"disabled"),this.defaults.queue)for(u=this._fileQueue,i=0,s=u.length;s>i;i++)o=u[i],o.index===t&&(o.state="cancelled");return r.cancel(t)}},t.prototype.uploadInfo=function(e,t,l){return this.defaults.debug?console.log("INFO: File:",t,"Index:",l,"Message:",e):void 0},t.prototype.uploadWarn=function(e,t,l){return this.defaults.debug?console.log("WARN: File:",t,"Index:",l,"Message:",e):void 0},t.prototype.uploadError=function(e,t,a){var n;return this.defaults.debug&&console.log("ERROR: File:",t,"Index:",a,"Message:",e),this._failed++,n=this.getMeterEl(a),l(n,this.defaults.uploadFailedClass)},t.prototype.processQueue=function(){var e,t,l,a,n;if(!this.defaults.queue)return!1;for(a=this._fileQueue,n=[],e=0,t=a.length;t>e;e++)l=a[e],"unprocessed"===l.state&&(this.defaults.uploadHandler(l.file,l.index),n.push(l.state="processed"));return n},t.prototype.cancelAll=function(){var e,t,l,a,r,i,s,o,u;for(e=this.el.querySelectorAll(this.defaults.cancelSelector),t=0,a=e.length;a>t;t++)u=e[t],n(u,"disabled")||u.click();if(this.defaults.queue){for(s=this._fileQueue,o=[],l=0,r=s.length;r>l;l++)i=s[l],"unprocessed"===i.state?(this.emit("candru-queue-cancelled",i.file,i.index,"cancelled"),o.push(i.state="cancelled")):o.push(void 0);return o}},t.prototype.getFileCount=function(){return this._index},t.prototype.allFilesFinished=function(){return this._index===this._complete+this._failed+this._cancelled},t}(Emitter);